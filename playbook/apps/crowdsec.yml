---

- hosts: 

  vars:
    application: crowdsec

    docker_network: 

    SLACK_WEBHOOK: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      35326630306461616261666463633063653065303034393230393730316662323663396633336664
      3262303339353131333431336632303533303533353734300a613764613265336266303930613431
      62643734653236643938623231383933316335666464303933653764643334633532383333303165
      3234633432613033310a633534313139343438646565306239346266366262306534376166383466
      31333165303936626437373062643662633266633964653064393437373335376564356533613762
      65636535316537306666653564316561346437353838363237613738363634666332613437626536
      64366534663261323437316336333231663431353565326532323536386564353864303934613935
      62656237396334346239353935396164353139656536326435343432323161393735323161666130
      6538

  handlers:
    - name: Restart
      community.docker.docker_container:
        name: "{{ application }}"
        restart: true
        comparisons:
          '*': ignore

  tasks:

    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0771"

    - name: Create acquis.yaml
      ansible.builtin.copy:
        content: |
          ---
          filenames:
            - /var/log/traefik/*.log
          labels:
            type: traefik
          ---
          filenames:
            - /var/log/kern.log
            - /var/log/ufw.log
            - /var/log/mail.log
          labels:
            type: syslog
        dest: "{{ config_directory }}/acquis.yaml"
        owner: "{{ common_root_id }}"
        group: "{{ common_root_group }}"
        mode: "0644"
      notify: Restart


    - name: Create email.yaml
      ansible.builtin.copy:
        content: |
          type: email
          name: email

          log_level: info

          {% raw %}
          format: |
            {{ range . -}}
            {{ $alert := . -}}

            {{ range .Decisions -}}
            <p><a href=https://www.shodan.io/host/{{ .Value}}>{{ .Value}}</a> will get <b>{{ .Type}}</b> for next <b>{{ .Duration}}</b> for triggering <b>{{ .Scenario}}</b>.</p>
            {{ end -}}

            <ul>
            {{ range .Events -}}
            {{ range .Meta }}{{ if eq .Key "traefik_router_name"}}<li>{{ .Value}}: {{ end }}{{ end }}{{ range .Meta }}{{ if eq .Key "http_path" }}{{ .Value }}{{ end }}{{ end }}</li>
            {{ end -}}
            </ul>

            {{ end -}}
          {% endraw %}

          smtp_host: {{ common_email_host }}
          smtp_username: {{ common_smtp_username }}
          smtp_password: {{ common_smtp_password }}
          smtp_port: {{ common_email_port }}
          sender_email: alerts{{ common_email_to }}
          receiver_emails:
           - {{ application }}{{ common_email_to }}
          encryption_type: starttls
          auth_type: login
          email_subject: CrowdSec Notification

          timeout: 20s
        dest: "{{ config_directory }}/email.yaml"
        owner: "{{ common_root_id }}"
        group: "{{ common_root_group }}"
        mode: "0644"
      notify: Restart

    - name: Create slack.yaml
      ansible.builtin.copy:
        content: |
          type: slack
          name: slack

          log_level: info

          {% raw %}
          format: |
            {{ range . -}}
            {{ $alert := . -}}

            {{ range .Decisions -}}
            {{if $alert.Source.Cn -}}
            :flag-{{$alert.Source.Cn}}: <https://www.whois.com/whois/{{.Value}}|{{.Value}}> will get {{.Type}} for next {{.Duration}} for triggering {{.Scenario}} on machine '{{$alert.MachineID}}'. <https://app.crowdsec.net/cti/{{.Value}}|CrowdSec CTI>{{end}}
            {{if not $alert.Source.Cn -}}
            :pirate_flag: <https://www.whois.com/whois/{{.Value}}|{{.Value}}> will get {{.Type}} for next {{.Duration}} for triggering {{.Scenario}} on machine '{{$alert.MachineID}}'.  <https://app.crowdsec.net/cti/{{.Value}}|CrowdSec CTI>{{end}}
            {{ end -}}
            {{ end -}}
          {% endraw %}

          webhook: {{ SLACK_WEBHOOK }}
        dest: "{{ config_directory }}/slack.yaml"
        owner: "{{ common_root_id }}"
        group: "{{ common_root_group }}"
        mode: "0644"
      notify: Restart

    - name: Create my-whitelists.yaml
      ansible.builtin.copy:
        content: |
          name: crowdsecurity/my-whitelists
          description: "Custom Whitelist"
          whitelist:
            reason: "my custom whitelists"
            ip:
              - "127.0.0.1"
            cidr:
              - "172.16.0.0/12" # LAN
              - "172.18.0.0/12" # Docker
        dest: "{{ config_directory }}/my-whitelists.yaml"
        owner: "{{ common_root_id }}"
        group: "{{ common_root_group }}"
        mode: "0644"
      notify: Restart
    
    - name: Create container
      community.docker.docker_container:
        name: "{{ application }}"
        image: crowdsecurity/crowdsec:v1.6.0
        state: started
        restart_policy: always
        published_ports:
          - 8080:8080
        volumes:
          - "{{ config_directory }}/data:/var/lib/crowdsec/data"
          - "{{ config_directory }}/config:/etc/crowdsec"

          - "{{ common_directory }}/crowdsec/logs:/var/log/crowdsec:ro"

          - "{{ config_directory }}/acquis.yaml:/etc/crowdsec/acquis.yaml"

          - "{{ config_directory }}/my-whitelists.yaml:/etc/crowdsec/parsers/s02-enrich/my-whitelists.yaml"

          - "{{ config_directory }}/email.yaml:/etc/crowdsec/notifications.local/email.yaml"
          - "{{ config_directory }}/slack.yaml:/etc/crowdsec/notifications.local/slack.yaml"

          - "{{ common_directory }}/traefik/logs:/var/log/traefik:ro"

          - /var/log/kern.log:/var/log/kern.log:ro
          - /var/log/ufw.log:/var/log/ufw.log:ro
          - /var/log/mail.log:/var/log/mail.log:ro

        env:
          TZ: "{{ common_timezone }}"
          PUID: "{{ common_user_id | string }}"
          PGID: "{{ common_group_id | string }}"

          COLLECTIONS: |-
            {{
              [
                "crowdsecurity/traefik",
                "crowdsecurity/http-cve",
                "crowdsecurity/iptables",
                "crowdsecurity/linux-lpe",
                "crowdsecurity/linux",
                "LePresidente/authelia",
                "LePresidente/overseerr",
              ] | join(' ')
            }}

        networks:
          - name: "{{ docker_network }}"
        labels:
          '{
            "chadburn.enabled": "true",
            "chadburn.job-exec.{{ application }}-hub.user": "0",
            "chadburn.job-exec.{{ application }}-hub.schedule": "@every 1h",
            "chadburn.job-exec.{{ application }}-hub.command": "sh -c \"cscli hub update && cscli hub upgrade\"",
            "chadburn.job-exec.{{ application }}-hub.tty": "false",
            "chadburn.job-exec.{{ application }}-hub.no-overlap": "true"
          }'
 
