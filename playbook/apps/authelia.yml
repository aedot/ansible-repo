---

- hosts: 

  vars:
    application: authelia
    
    docker_network: 

    jwt_secret: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      37323665626236616238626332303735333638656263643137323736326233336336303361386630
      3862633430656333643936363666303835376638613539320a636536316235323262303538343033
      39313733353635633731303364366533663137346566663737386333383938663035666439633262
      3433663365383461380a333732643734663462306565373336613562363061316237306236623363
      33353865333636306438396639656662666131373438333865353636386532373564393366653063
      3661336335393131326238613938303237613839623438333635

    session_secret: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      30643939323136393361623936323366393464353430663732643938656166643664393036616363
      3038666236303036613031663637643830353731646436320a663062323539326533646536383739
      64393237303561616139326631653335326534303962323565363239316630363139363832353438
      6165383237383732330a396634393332646663366665313233626635666638623337613334336137
      35316339666463393834643363373666343730343164323161383938306637383766

    storage_encryption_key: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      39613430316336663738336433353464366262303333656636383762306530663634613033636337
      6339623733626564663862353963333737653666663061650a316131353666316363643836303864
      66323433643366636338393364633832623339636162613161656238393432653534323534373533
      3133663536366134630a633435353832666265383836333262666537366362333161303835323365
      64336664333435343830636337346539376362363136613461313961636163363632

    db_password: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      33633163646338383831383565633138376635646138373034366634616661303464346666653834
      3537333064393362346636643263666630316662343265350a626232356238343734366137643766
      36616134646639623535613031653161396663336634363835613964653438613063643164363733
      3238383238343065650a366632323863626338663865616564376362313037666561396133343033
      33353238363933393364626434303765663436643537353061613431643062363732646133333463
      3264346630366262353534346263323738356130613835613632

  handlers:
    - name: Restart
      community.docker.docker_container:
        name: "{{ application }}"
        restart: true
        comparisons:
          '*': ignore

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0771"

    - name: Create keys folder
      ansible.builtin.file:
        path: "{{ config_directory }}/keys"
        state: directory
        owner: "root"
        group: "root"
        mode: "0771"

    - name: Generate a private key
      community.crypto.openssl_privatekey:
        path: "{{ config_directory }}/keys/private.pem"
        type: RSA
        size: 4096
        return_content: true
      register: _authelia_private_key

    - name: Create authelia folder
      ansible.builtin.file:
        path: "{{ config_directory }}/authelia"
        state: directory
        owner: "root"
        group: "root"
        mode: "0771"

    - name: Template config
      ansible.builtin.template:
        src: "{{ files_directory }}/configuration.yml.j2"
        dest: "{{ config_directory }}/authelia/configuration.yml"
        owner: "{{ common_root_id }}"
        group: "{{ common_root_group }}"
        mode: "0444"
        validate: "docker run --rm --name {{ application }}_config_check -v %s:/tmp/config.yml --entrypoint authelia ghcr.io/authelia/authelia:latest validate-config --config /tmp/config.yml"
      notify: Restart

    - name: Create container
      community.docker.docker_container:
        name: "{{ application }}"
        image: ghcr.io/authelia/authelia:4.38.8
        state: started
        restart_policy: unless-stopped
        env:
          TZ: "{{ common_timezone }}"
        published_ports:
          - 9091:9091
        networks:
          - name: "{{ docker_network }}"
        volumes:
          - "{{ config_directory }}/authelia:/config"
          - "{{ config_directory }}/logs:/var/log/authelia"
        labels:
          '{
            "traefik.enable": "true",
            "traefik.http.routers.{{ application }}.rule": "Host(`auth.{{ common_tld }}`)",
            "traefik.http.routers.{{ application }}.entrypoints": "https",

            "traefik.http.routers.{{ application }}.tls": "true",
            "traefik.http.middlewares.{{ application }}.forwardauth.address": "http://authelia:9091/api/verify?rd=https://auth.{{ common_tld }}",
            "traefik.http.middlewares.{{ application }}.forwardauth.trustForwardHeader": "true",
            "traefik.http.middlewares.{{ application }}.forwardauth.authResponseHeaders": "Remote-User, Remote-Groups, Remote-Name, Remote-Email",
          }'
