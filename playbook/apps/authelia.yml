---

- hosts: 

  vars:
    application: authelia
    docker_network: 

    jwt_secret: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      37323665626236616238626332303735333638656263643137323736326233336336303361386630
      3862633430656333643936363666303835376638613539320a636536316235323262303538343033
      39313733353635633731303364366533663137346566663737386333383938663035666439633262
      3433663365383461380a333732643734663462306565373336613562363061316237306236623363
      33353865333636306438396639656662666131373438333865353636386532373564393366653063
      3661336335393131326238613938303237613839623438333635

    session_secret: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      30643939323136393361623936323366393464353430663732643938656166643664393036616363
      3038666236303036613031663637643830353731646436320a663062323539326533646536383739
      64393237303561616139326631653335326534303962323565363239316630363139363832353438
      6165383237383732330a396634393332646663366665313233626635666638623337613334336137
      35316339666463393834643363373666343730343164323161383938306637383766

    storage_encryption_key: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      39613430316336663738336433353464366262303333656636383762306530663634613033636337
      6339623733626564663862353963333737653666663061650a316131353666316363643836303864
      66323433643366636338393364633832623339636162613161656238393432653534323534373533
      3133663536366134630a633435353832666265383836333262666537366362333161303835323365
      64336664333435343830636337346539376362363136613461313961636163363632

    redis_password: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      39303561653562336163646334663435646138616537393664366533306365626162623933343366
      6331666234636165313732313534303930363037666465310a343731663064646336623430313739
      63613464653364636265343062326466383138323037383330363939386133663939306133633538
      3865656230343830360a623830313133326563363533383434333038343562343232326438623230
      37326437323335323063306531326231653062633039376562373136333464393138623762353735
      6363386335616666363538623032313935303735333666316236

    mysql_password: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      35663439633832313336623439646534623837643635396366636331653233626362626431333933
      3034386662373534306339646165613863316665353832650a313366376661653165396639663830
      30616634386438353635303835656632303734376431373164363937636464666662303039363834
      6466666662356234300a303238666463396663623733343031623563633664333138346438353961
      37663034626336376636383765386531303261656434343164353939633261333764626463353862
      3538363663633465653632303062373331363235663638383266

  handlers:
    - name: Restart
      community.docker.docker_container:
        name: "{{ application }}"
        restart: true
        comparisons:
          '*': ignore

  tasks:
    - name: Create authelia folder
      ansible.builtin.file:
        path: "{{ config_directory }}/config"
        state: directory
        owner: "root"
        group: "root"
        mode: "0771"

    - name: Template config
      ansible.builtin.template:
        src: "{{ files_directory }}/{{ item }}.j2"
        dest: "{{ config_directory }}/config/{{ item }}"
        owner: "{{ common_root_id }}"
        group: "{{ common_root_group }}"
        mode: "0444"
      loop:
        - configuration.yml
        - users_database.yml
      notify: Restart

    - name: Create container
      community.docker.docker_container:
        name: "{{ application }}"
        image: ghcr.io/authelia/authelia:latest
        state: started
        restart_policy: unless-stopped
        env:
          TZ: "{{ common_timezone }}"
        published_ports:
          - 9091:9091
        networks:
          - name: "{{ docker_network }}"
        volumes:
          - "{{ config_directory }}/config:/config"
          - "{{ config_directory }}/logs:/var/log/authelia"

          - /var/log/crowdsec:/var/log/crowdsec
        labels:
          '{
            "traefik.enable": "true",
            "traefik.http.routers.{{ application }}.rule": "Host(`auth.{{ common_tld }}`)",
            "traefik.http.routers.{{ application }}.entrypoints": "https",
            "traefik.http.routers.{{ application }}.tls": "true",
            "traefik.http.middlewares.{{ application }}.forwardauth.address": "http://authelia:9091/api/verify?rd=https://auth.{{ common_tld }}",
            "traefik.http.middlewares.{{ application }}.forwardauth.trustForwardHeader": "true",
            "traefik.http.middlewares.{{ application }}.forwardauth.authResponseHeaders": "Remote-User, Remote-Groups, Remote-Name, Remote-Email",
          }'