---

- hosts: 

  vars:
    application: authelia
    
    docker_network: 

    authelia_jwt_secret: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      37323665626236616238626332303735333638656263643137323736326233336336303361386630
      3862633430656333643936363666303835376638613539320a636536316235323262303538343033
      39313733353635633731303364366533663137346566663737386333383938663035666439633262
      3433663365383461380a333732643734663462306565373336613562363061316237306236623363
      33353865333636306438396639656662666131373438333865353636386532373564393366653063
      3661336335393131326238613938303237613839623438333635

    authelia_session_secret: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      38643766303130373035663634303535626563396333353530303863346632633237356130623539
      3534646663613134633739313330316561663461376466300a383931643537643534646363363036
      39303837353864653431663164303764323662356637363432653733373231363933633438373135
      6561343533636632640a376366343663663132636631326637343061303039303962643664343464
      39346635626136376332363530623132383763366239333132373637663739383133353833663064
      35646630323731633961626262633663626665316466636264303031643430386564363063613833
      38613030363563646631313034376133323235393936343635643930626231393032353264313763
      64313034643735613762

    authelia_storage_encryption_key: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      33306130356332383230323035383538323732626430386461373365346462653238363332393565
      6566613363646430363931303065633035383862393261300a326132363563653839616265396362
      37346261366566623337343136326564353932633231376264623832343531623966396637376261
      3663663137663536340a393065666433663163313731663831613164373463396363616362373537
      66353430386132383735363065313436616364623666383631336232666462383233313730663130
      61653064363535313333336535313638393036383136653933323166316462366437633031653762
      32616537313563646130343930303139303639613565326566376338306236373965646435666634
      35666233393234633732

    authelia_postgres_password: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      34316439613639636133363034343933663437356330333738616366346335646231666635333236
      3733393465646466366438653531353933353234366236320a323536623464303536333337633535
      38323566383934653738336331313135376233383739616166346261663164363065393634326562
      6631613839333332370a666638643931323431336236366465353863383837633530366266353466
      63333361656663653531386330646262373032623962326266393961323365353637366261663164
      6663383135663734393366333566383035623135383534643134

    authelia_postgres_user: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      32346464343436626438396235306339323364393866663833643164373331616137323838383538
      3837353732633930323866363966363037396239366538330a393130393337333538383232613766
      35386232366361623261313436636362663766626263393636623434613835636336653166663133
      3266646561396666370a373332353636356635346436346134653961346230316464643062393764
      3864

    authelia_redirect_url: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      34303864303333623565333166323832663531363239616133353436363366633735313765306139
      3366393435336662373765643730656232633733366331660a393764326462323033623433383534
      37386462393063613262626136613536366166633937653630373563303966653933313239313439
      6631353165633637360a616462633134623962313330356361383237363239616466326436373761
      31336339373236396364636539633335323365653038366466323734353162313730363433313632
      64633636656433366437313638383565616436303737393634663864373134393535626337613735
      613838313862643839303933306139333662

  handlers:
    - name: Restart
      community.docker.docker_container:
        name: "{{ application }}"
        restart: true
        comparisons:
          '*': ignore

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0771"

    - name: Create keys folder
      ansible.builtin.file:
        path: "{{ config_directory }}/keys"
        state: directory
        owner: "root"
        group: "root"
        mode: "0771"

    - name: Generate a private key
      community.crypto.openssl_privatekey:
        path: "{{ config_directory }}/keys/private.pem"
        type: RSA
        size: 4096
        return_content: true
      register: _authelia_private_key

    - name: Template config
      ansible.builtin.template:
        src: "{{ files_directory }}/configuration.yml.j2"
        dest: "{{ config_directory }}/configuration.yml"
        owner: "{{ common_root_id }}"
        group: "{{ common_root_group }}"
        mode: "0444"
        validate: "docker run --rm --name {{ application }}_config_check -v %s:/tmp/config.yml --entrypoint authelia ghcr.io/authelia/authelia:latest validate-config --config /tmp/config.yml"
      notify: Restart

    - name: Create container
      community.docker.docker_container:
        name: "{{ application }}"
        image: ghcr.io/authelia/authelia:latest
        state: started
        restart_policy: unless-stopped
        env:
          TZ: "{{ common_timezone }}"
        published_ports:
          - 9091:9091
        networks:
          - name: "{{ docker_network }}"
        volumes:
          - "{{ config_directory }}:/config"
          - "{{ config_directory }}/logs:/var/log/authelia"
        labels:
          '{
            "traefik.enable": "true",
            "traefik.http.routers.{{ application }}.rule": "Host(`auth.{{ common_tld }}`)",
            "traefik.http.routers.{{ application }}.entrypoints": "https",

            "traefik.http.routers.{{ application }}.tls": "true",
            "traefik.http.middlewares.{{ application }}.forwardauth.address": "http://authelia:9091/api/verify?rd=https://auth.{{ common_tld }}",
            "traefik.http.middlewares.{{ application }}.forwardauth.trustForwardHeader": "true",
            "traefik.http.middlewares.{{ application }}.forwardauth.authResponseHeaders": "Remote-User, Remote-Groups, Remote-Name, Remote-Email",
          }'
