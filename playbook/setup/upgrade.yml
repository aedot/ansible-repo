---

- hosts: all

  vars:
    DISCORD_WEBHOOK: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      36633231306138653466383363643637656633643130326134366334393537326232653864363830
      6364303239623062333965653635323339386338353763300a356335353762613561316238633738
      33343032323361383062363261363563303561353239613632633434396562366339616131326566
      3531316537313164350a376161666131353734383738313064633530646138643162663435653435
      33643131626331613136303839323132323763646362373037366562343235356363383432303565
      39383961373637363965653131613764353731353432336238643138656434316339396466303064
      30396465303465323764653033366637313234363536363932306663663161336266346632363235
      31303035313961386461656235396666633465633335303431396630353830616534393163306266
      66376534663661646235313965353861636636306638666466353066313633386633356661323733
      6461393330643638393261303136656637323830663935643736

  tasks:
    - name: Make sure everything's up to date
      ansible.builtin.apt:
        upgrade: dist
        update_cache: yes

    - name: check if system rebooot is required
      stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Send Discord notification
      uri:
        url: "{{ DISCORD_WEBHOOK }}"
        method: POST
        body_format: json
        body: '{"content": "Reboot required on {{ inventory_hostname }}"}'
        headers:
          content-Type: application/json
        status_code: 204
      when: reboot_required.stat.exist